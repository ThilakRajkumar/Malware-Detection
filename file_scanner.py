import requests
import time

API_KEY = 'e12e81636979414f0e10cf787195adcfca205062c460746db33dd0cffbce42ea'

def scan_file_vt(file):
    url = 'https://www.virustotal.com/vtapi/v2/file/scan'
    params = {'apikey': API_KEY}
    files = {'file': (file.filename, file.read())}

    response = requests.post(url, files=files, params=params)
    
    if response.status_code == 200:
        scan_id = response.json().get('scan_id')
        return get_file_report(scan_id)
    else:
        return {'error': 'Error in file scanning', 'status_code': response.status_code}

def get_file_report(scan_id):
    url = 'https://www.virustotal.com/vtapi/v2/file/report'
    params = {'apikey': API_KEY, 'resource': scan_id}

    # Poll for the report until we get results
    for _ in range(5):
        response = requests.get(url, params=params)
        result = response.json()

        if response.status_code == 200 and result.get('response_code') == 1:
            return {
                'scan_result': result.get('positives'),
                'total_scans': result.get('total'),
                'scan_report': result.get('scans')
            }
        else:
            time.sleep(5)  # Wait before polling again

    return {'error': 'Unable to retrieve report'}
